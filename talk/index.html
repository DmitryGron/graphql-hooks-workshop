<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' />
  <title>Big</title>
  <link href='big.css' rel='stylesheet' type='text/css' />
  <link href='highlight.css' rel='stylesheet' type='text/css' />
  <style>
    .new-shiny { background: #aaaaaa; }

    @-webkit-keyframes blinker {
      from { opacity: 1.0; }
      to { opacity: 0.5; }
    }

    .blink {
      -webkit-animation-name: blinker;
      -webkit-animation-iteration-count: infinite;
      -webkit-animation-timing-function: cubic-bezier(1.0,0,0,1.0);
      -webkit-animation-duration: 800ms;
    }
  </style>
  <script src='big.js'></script>
  <script src='highlight.js'></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>
<body class='dark'>
  <div class="title">
    <div style="height: 30%">
      graphql-<span class="bubblegum">hooks</span>
      <em><i><span class="blink">Workshop</span></i></em>
    </div>
    <div style="font-size: 0.2em">
      <span class="supersplit">@</span>...
    </div>
  </div>
  <div>
    <img src='./nearform.svg' width='100'>
  </div>
  <div>
    <span class="bubblegum">React Hooks</span> are...</em>
  </div>
  <div>
    <span class="bubblegum">reusable stateful logic functions</span><span> that do not obstruct the view hierarchy</span>
  </div>
  <div>
    <ul>
      <li>Store and manage local state</li>
      <li>Respond to component lifecycle events</li>
      <li>Better separation of concerns</li>
      <li>Function component approach</li>
    </ul>
  </div>
  <div>
    Graph<span class="bubblegum">QL</span> is a data query language <em>for API</em>
  </div>
  <div>
    Graph<span class="bubblegum">QL</span>
    <ul>
      <li>Strongly typed query language is self-documenting</li>
      <li>Declarative language expressing data requirements</li>
      <li>Lighter and faster responses without roundtrips</li>
      <li>Single endpoint to do all the things</li>
    </ul>
  </div>
  <div>
    Introducing <em>graphql-hooks!</em>
  </div>
  <div><em>graphql-hooks</em> is a tiny hooks-first and super-fast Graph<span class="bubblegum">QL</span> client</div>
  <div><em>graphql-hooks</em>
    <ul>
      <li><code>github.com/nearform/graphql-hooks</code></li>
      <li><code>www.npmjs.com/package/graphql-hooks</code></li>
    </ul>
  </div>
  <div><em>graphql-hooks-workshop</em><br /><br />
    <code>github.com/nearform/graphql-hooks-workshop</code>

  </div>
  <div>
    <u><em>Setup</em></u>
    <ul>
      <li>Node v10.16.0</li>
      <li>clone github repository</li>
    </ul>
  </div>
  <div><code><pre>git clone git@github.com:nearform/graphql-hooks-workshop.git</pre></code></div>
  <div><em>Part 1:</em> Hello World</div>
  <div>
    <em><u>Goals</u></em>
    <ul>
      <li>Get a Graph<span class="bubblegum">QL</span> Server up and running</li>
      <li>Explore <span class="bubblegum">Graph</span><i>i</i><em>QL</em></li>
    </ul>
  </div>
  <div>
    <em><u>Stack</u></em>
    <ul>
      <li>Node.js</li>
      <li>Fastify</li>
      <li>React</li>
      <li>Graph<span class="bubblegum">QL</span></li>
    </ul>
  </div>
  <div>
    <u><em>Hello World Setup</em></u>
    <ul>
      <li><code>cd graphql-hooks-workshop/exercises/part-1-hello-world/</code></li>
      <li><code>npm install</code></li>
      <li><code>npm run watch</code></li>
      <li><span class="bubblegum">http://localhost:3000</span></li>
    </ul>
  </div>
  <div>
    <ul>
      <li>Navigate to the <em>List Users</em> page</li>
      <li>This is just a skeleton</li>
      <li>It is not connected to Graph<span class="bubblegum">QL</span>... yet</li>
    </ul>
  </div>
  <div>
    Look at <em><code>src/server/graphql.js</code></em>
    <ul>
      <li><span class="bubblegum">fastify-gql</span> module</li>
      <li>data</li>
      <li>schema</li>
      <li>resolvers</li>
      <li><em><code>graphiql: <span class="bubblegum">true</span></code></em></li>
    </ul>
  </div>
  <div style="text-align: center;">
    <img src="./bench.png" style="width: 50% !important;"></a>
  </div>
  <div><span class="bubblegum">graph</span><i>i</i><em>QL</em></div>
  <div>
  <span class="bubblegum">graph</span><i>i</i><em>QL</em>
    is an in-browser IDE for exploring Graph<span class="bubblegum">QL</span><br />
  </div>
  <div>
    <span class="bubblegum">
      http://localhost:3000/graphiql.html
    </span>
  </div>
  <div>
    <em>RUN THIS QUERY</em>
    <pre><code>
{
  users {
    name
  }
}
    </code></pre>
  </div>
  <div><em>Part 2:</em> Graph<span class="bubblegum">QL</span> Schema</div>
  <div>
    <em><u>Goals</u></em>
    <ul>
      <li>Update the Graph<span class="bubblegum">QL</span> schema to <em>Create a User</em></li>
      <li>Test it with <span class="bubblegum">Graph</span><i>i</i><em>QL</em></li>
    </ul>
  </div>
  <div>
    <u>Graph<span class="bubblegum">QL</span> <em>Schema Setup</em></u>
    <ul>
      <li><code>cd graphql-hooks-workshop/exercises/part-2-schema/</code></li>
      <li><code>npm install</code></li>
      <li><code>npm run watch</code></li>
      <li><span class="bubblegum">http://localhost:3000</span></li>
    </ul>
  </div>
  <div><em>Look at</em> <code class=javascript><pre>src/server/graphql.js</pre></code></div>
  <div>A Graph<span class="bubblegum">QL</span> schema defines the <em>relationships</em> and <em>structure</em> of the data
  </div>
  <div>In the current <em>schema</em><br />
    <span class="bubblegum">Query</span> is the <em>entry point</em><br />
    that provides the type <span class="bubblegum">User</span>
    <pre><code>
const schema = `
  type User {
    name: String
  }

  type Query {
    users: [User]
  }
`
</code></pre>
  </div>
  <div>Graph<span class="bubblegum">QL</span> <em>resolvers</em> are functions that define what to do with the data
  </div>
  <div>In the current <em>resolver</em><br />
    <span class="bubblegum">Query</span> defines what to do with the <em>schema</em><br />
    in this case, to fetch all of the <span class="bubblegum">users</span>
    </ul>
    <pre><code>
const resolvers = {
  Query: {
    users() {
      return users
    }
  }
}
</code></pre>
  </div>
  <div>Generally, in Graph<span class="bubblegum">QL</span>
    <ul>
      <li><em>Queries</em> are for <span class="bubblegum">fetching</span></li>
      <li><em>Mutations</em> are for <span class="bubblegum">writing</span></li>
    </ul>
  </div>
  <div>To <em>Create a User</em>,
    add a <span class="bubblegum">mutation</span> to the <em>schema</em> and <em>resolvers</em> in <code>graphql.js</code>
  </div>
  <div>
    <em>Modify <u><code class=javascript>src/server/graphql.js</code></u></em>
    <pre><code>
const schema = `
  type User {
    name: String
  }

  type Query {
    users: [User]
  }

  type Mutation {
    createUser(name: String!): User
  }
`
</code></pre>
  </div>
  <div>
    <em>Modify <u><code class=javascript>src/server/graphql.js</code></u></em>
    <pre><code>
const resolvers = {
  Query: {
    users() {
      return users
    }
  },
  Mutation: {
    createUser: (_, user) => {
      users.push(user)
      return user
    }
  }
}
</code></pre>
  </div>
  <div>Test the new <em>Create a User</em> mutation<br /><br />
    <u><span class="bubblegum">Graph</span><i>i</i><em>QL</em></u><br /><br />
    <span class="bubblegum">
      http://localhost:3000/graphiql.html
    </span>
  </div>
  <div><em>RUN THIS QUERY</em>
    <pre><code>
mutation CreateUser($name: String!){
  createUser(name: $name) {
    name
  }
}
  </code></pre>
  </div>
  <div>Don't forget to add <em>Query Variables</em>
    <pre><code>
{
  "name": "bob"
}
  </code></pre>
  </div>
  <div>
    <em>Test it</em>
    <pre><code>
{
  users {
    name
  }
}
    </code></pre>
  </div>
  <div><em>Part 3:</em> graphql-hooks</div>
  <div>
    <em><u>Goals</u></em>
    <ul>
      <li>See <span class="bubblegum">graphql-hooks</span> in action</li>
      <li>Connect the back-end data to the front-end webpage</li>
      <li>Retrieve a list of <em>users</em> from an API using a <span class="bubblegum">graphql hook</span></li>
    </ul>
  </div>
  <div>
    <em><u>graphql-hooks setup</u></em>
    <ul>
      <li><code>cd graphql-hooks-workshop/exercises/part-3-graphql-hooks/</code></li>
      <li><code>npm install</code></li>
      <li><code>npm run watch</code></li>
    </ul>
  </div>
  <div>
    <em>Install graphql-hooks</em>
    <br /><br />
    <code><pre>npm install graphql-hooks</pre></code>
  </div>
  <div>
    <em>Modify src/client/js/app-shell.js</em><br /><br />
    <div>Create a Graph<span class="bubblegum">QL</span> client</div>
    <pre><code class=javascript>
import { GraphQLClient } from 'graphql-hooks'

const client = new GraphQLClient({
  url: '/graphql'
})
    </code></pre>
  </div>
  <div>
    <em>Wrap the app with provider</em>
    <br /><br />
    <pre><code class=javascript>
import {
  GraphQLClient,
  ClientContext
} from 'graphql-hooks'

const client = new GraphQLClient({
  url: '/graphql',
})

const App = (
  &lt;ClientContext.Provider value={client}>
    &lt;AppShell />
  &lt;/ClientContext.Provider>
)
    </code></pre>
  </div>
  <div>
    <em>Modify <code>src/app/pages/ListUsers.js</code></em><br /><br />
    <div>Query GraphQL</div>
    <pre><code class=javascript>
import { useQuery } from 'graphql-hooks'
const LIST_USERS_QUERY = `
  query ListUsersQuery {
    users {
      name
    }
  }
`

const { loading, error, data } = useQuery(QUERY)
    </code></pre>
  </div>
  <div>
    <em>Hook details</em>
    <pre><code class=javascript>
const {
  loading,        // Boolean, is it completed?
  error,          // Boolean, was it successful?
  data,           // JSON received from API
  refetch,        // Function to trigger refetch
  cacheHit,       // Data from the cache?
  fetchError,
  httpError,
  graphQLErrors   // Errors
} = <em>useQuery</em>(<em>QUERY</em>, {
  variables: {},  // Does the query include variables?
  useCache,       // Boolean, OK to lookup the cache first?
  skipCache       // Boolean, tore the response in cache?
})
    </code></pre>
  </div>
  <div>Next <span class="bubblegum">an exercise</span></div>
  <div>
    <div>Coding...</div>
  </div>
  <div><em>Part 4:</em> Query Variables</div>
  <div>
    <em><u>Goal</u></em>
    <div>Implement page-based <em>pagination</em></div>
  </div>
  <div>
    <div><em>Step 1</em></div>
    <div>Prepare backend resolver</div>
    <pre><code class=javascript>
const resolvers = {
  Query: {
    users: (_, { skip = 0, limit }) => {
      const end = limit
        ? skip + limit
        : undefined
      return users.slice(skip, end)
    }
  }
}
    </code></pre>
  </div>
  <div>
    <div><em>Step 2</em></div>
    <div>Tune the query</div>
    <pre><code class=javascript>
const USERS_QUERY = `
  query UsersQuery($skip: Int, $limit: Int) {
    users(skip: $skip, limit: $limit) {
      name
    }
  }
`
    </code></pre>
  </div>
  <div>
    <div><em>Step 3</em></div>
    <div>Execute the query</div>
    <pre><code class=javascript>
const { data } = <em>useQuery</em>(USERS_QUERY, {
  variables: {
    limit: 1,
    skip: page - 1
  }
})
    </code></pre>
  </div>
  <div>
    <div><span class="bubblegum">An exercise</span></div>
    <div>Let's implement pagination for users page</div>
  </div>
  <div><em>Part 5:</em> Caching</div>
  <div>
    <em><u>Goal</u></em>
    <div>Do not repeat the identical requests</div>
  </div>
  <div>
    <em>refetch</em> no more
  </div>
  <div>
    <em>graphql-hooks</em> supports custom cache plug-ins
  </div>
  <div>
    <em><u>graphql-hooks-memcache</u></em>
    <ul>
      <li>document based</li>
      <li>creates a hash of the operation and its options</li>
      <li>stores it in a simple k/v store</li>
      <li>uses Least Recently Used policy</li>
    </ul>
  </div>
  <div>
      <pre><code class=javascript>
import memCache from 'graphql-hooks-memcache'

const client = new GraphQLClient({
  url: '/graphql',
  cache: memCache({
    // For rehydration (mostly after SSR)
    initialState,

    // Expiration of cache item in milliseconds
    ttl,

    // Number of items to cache
    size
  })
})
    </code></pre>
  </div>
  <div>
    <div><span class="bubblegum">An exercise</span></div>
    <div>Add react-hooks-memcache to ListUsers</div>
  </div>
  <div>
    How to <em>test</em> it?
  </div>
  <div>
    If we make a manual <span class="bubblegum">query</span> and then unmount and mount the 'ListUsers' component, we can test that the <em>cache</em> is working
  </div>
  <div><em>Part 6:</em> <span class="bubblegum">S</span>erver <span class="bubblegum">S</span>ide <span class="bubblegum">R</span>endering</div>
  <div>
    <em><u>Goal</u></em>
    <div>Speed up React app delivery</div>
  </div>
  <div>
    <div>Server Side Rendering</div>
    <ul>
      <li>Reuse client side app to render on the backend</li>
      <li>Use the same <em>graphql-hooks</em></li>
      <li>Serialize memcache and pass to the frontend</li>
      <li>Rehydrate cache object (initialState) on the frontend</li>
    </ul>
  </div>
  <div>
    <div><em>Step 1</em></div>
    <div>Supply <em>fetch</em> functionality</div>
    <ul>
      <li>Use <em>isomorphic-unfetch</em></li>
      <li>Switches to <em>node-fetch</em> on backend</li>
      <li>Uses <em>unfetch</em> on frontend</li>
    </ul>
  </div>
  <div>
    <em>Example</em>
    <pre><code class=javascript>
const client = new GraphQLClient({
  url: 'http://127.0.0.1:3000/graphql',
  fetch: require('isomorphic-unfetch'),
  cache: memCache(),
  logErrors: true
})
    </code></pre>
  </div>
  <div>
    <div><em>Step 2</em></div>
    <div>Serialize <em>initialState</em></div>
    <ul>
      <li>Use <em>graphql-hooks-ssr</em></li>
      <li>Serialize on the backend</li>
      <li>Pass to the frontend</li>
      <li>Rehydrate at the frontend</li>
    </ul>
  </div>
  <div>
    <em>Serialize initialState</em>
    <pre><code class=javascript>
import { getInitialState } from 'graphql-hooks-ssr'

const App = &lt;ClientContext.Provider value={client}>
  &lt;AppShell />
&lt;/ClientContext.Provider>
</code></pre>
<pre><code class=javascript>
const initialState = await getInitialState({
  App,    // React App
  client  // GraphQL client
})
    </code></pre>
  </div>
  <div>
    <em>Pass to the frontend</em>
    <pre><code class=javascript>
async function renderScripts({ initialState }) {
  const appShellBundlePath = await getBundlePath('app-shell.js')
  return `
    &lt;script type="text/javascript">
      window.__INITIAL_STATE__=${JSON.stringify(initialState).replace(
        /&lt;/g,
        '\\u003c'
      )};
    &lt;/script>
    &lt;script src="${appShellBundlePath}">&lt;/script>
  `
}
    </code></pre>
  </div>
  <div>
    <em>hydrate</em> at the frontend
    <pre><code class=javascript>
import memCache from 'graphql-hooks-memcache'

const initialState = window.__INITIAL_STATE__
const client = new GraphQLClient({
  url: '/graphql',
  cache: memCache({ initialState })
})
    </code></pre>
  </div>
  <div>
    <div><span class="bubblegum">An exercise</span></div>
    <div>Use SSR on ListUsers page</div>
  </div>
  <div>
    <em>graphql-hooks</em> are <span class="bubblegum">awesome!</span>
  </div>
  <div class="title">
    <div style="height: 30%" class="bubblegum">
      Thanks
    </div>
    <div style="font-size: 0.2em">
      <em>@</em>...
    </div>
  </div>
  <div>
    <img src='./nearform.svg' width='100'>
  </div>
</body>
</html>
